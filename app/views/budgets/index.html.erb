<% html_title "Budgets" %>
<%= stylesheet_link_tag 'budget', :plugin => 'redmine_budget' %>
<h2><%= l(:title_budget_tab) %></h2>

<!--option -->
<%= form_tag url_for(action: :index), method: :get, id: "query_form" do %>
  <fieldset id="filters" class="collapsible">
    <legend onclick="toggleFieldset(this);" class="icon icon-collapsed"><%= l(:label_options) %></legend>
    <div style="display: none;">
      <!-- selectable assignee -->
      <div class="evm-div-col">
        <fieldset><legend><%= l(:label_select_assignee) %></legend>
          <%= select_tag :selected_assignee_id,
              options_for_select(@selectable_assignees,
                                @cfg_param[:selected_assignee_id]),
                                { multiple: true, size: 5 }%>
        </fieldset>
      </div>
    </div>
  </fieldset>
  <!-- Apply button -->
  <%= label_tag('month', l(:label_month)) %>
  <%= select_month(@month, :prefix => "month", :discard_type => true) %>
  <%= label_tag('year', l(:label_year)) %>
  <%= select_year(@year, :prefix => "year", :discard_type => true) %>
  <p class="buttons">
    <%= link_to "#", {onclick: "$(this).closest('form').submit()", class: "icon icon-checked" } do l(:button_apply) end %>
    <%= link_to l(:button_clear), { basis_date: Date.today }, :class => "icon icon-reload"  %>
  </p>
<% end %>

<!-- Calender -->
<%= form_tag({}, :data => {:cm_url => issues_context_menu_path}) do -%>
  <%= hidden_field_tag 'back_url', url_for(:params => request.query_parameters), :id => nil %>
  <table class="budget-cal">
  <!-- Calender header -->
  <tr class="budget-cal-header">
    <td colspan="2"></td>
    <% @calendar.format_month.each do |day| %>
      <td class="<%= @calendar.day_css_classes(day) %> budget-cal-cell">
        <p class="day-num"><%= day.day %>
          <span class="abbr-day">(<%= abbr_day_name(day.cwday) %>)</span>
        </p>
      </td>
    <% end %>
  </tr>
  <!-- Calender contents -->
  <% if @cfg_param[:selected_assignee_id].present? %>
    <% @cfg_param[:selected_assignee_id].each do |user| %>
      <tr class="budget-cal-row budget-estimated">
        <td class="budget-cal-user" rowspan="2">
          <%= @selectable_assignees.invert[user.to_i] %>
        </td>
        <!-- estimated hours -->
        <td class="budget-cal-cell budget-estimated row-header">予</td>
        <% @calendar.format_month.each do |day| %>
          <td class="<%= @calendar.day_css_classes(day) %> budget-cal-cell budget-estimated">
            <p class="total-time">
              <%= "#{@calendar.total_estimated_hours(user, day).round(1)}" %>
            </p>
          </td>
        <% end %>
      </tr>
      <tr class="budget-cal-row budget-entry">
        <!-- time entries -->
        <td class="budget-cal-cell budget-entry row-header">実</td>
        <% @calendar.format_month.each do |day| %>
          <td class="<%= @calendar.day_css_classes(day) %> budget-cal-cell budget-entry">
            <p class="total-time">
              <%= "#{@calendar.total_time_entries(user, day).round(1)}" %>
            </p>
          </td>
        <% end %>
      </tr>
    <% end %>
  <% end %>
  </table>
<% end %>
<%= context_menu %>
